<html>
  <head>
    <title>Candy Magic</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <link rel="icon" sizes="192x192" href="favicon.png">
    <link rel="stylesheet" href="https://storage.googleapis.com/code.getmdl.io/1.0.4/material.green-light_green.min.css">
    <script src="https://storage.googleapis.com/code.getmdl.io/1.0.4/material.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <div id="connection">
      <div id="title">Candy Magic</div>
      <button id="find" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">Connect <i class="material-icons">bluetooth</i></button>
    </div>
    <div id="connected">
      <button id="d01" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent"></button>
      <button id="d02" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent"></button>
      <button id="d03" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent"></button>
      <button id="d04" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent"></button>
    </div>
    <div id="dispensing">
      <div id="loader"><img id="loader-gif" src="./images/loader.gif"></div>
    </div>
    <div id="thankyou">
      <div id="thankyoumsg">Thank you for using me!</div>
      <div id="btconnection"><i id="bticon" class="material-icons">bluetooth_connected</i></div>
      <div id="disconnectmsg">Connection will close automaticaly.</div>
    </div>
    
    <script type="text/javascript">
    var cntdDevice;
    function connectedHandler(type) {
        var connection, connected, thankyou;
        switch(type) {
            case "connected":
                connection="none";
                connected="block";
                thankyou="none";
                setTimeout(function(){
                    document.querySelector("#connected").style.setProperty("opacity", "1");
                }, 50);
                break;
            case "disconnected":
                connection="block";
                connected="none";
                thankyou="none";
                break;
            case "thankyou":
                connection="none";
                connected="none";
                thankyou="block";
                break;
        }
        document.querySelector("#connection").style.setProperty("display", connection);
        document.querySelector("#connected").style.setProperty("display", connected);
        document.querySelector("#thankyou").style.setProperty("display", thankyou);
    }
    function handleCandyMagic (characteristic) {
        var data = new Uint8Array([1]);
        document.getElementById("d01").addEventListener("mousedown", dispense);
        document.getElementById("d02").addEventListener("mousedown", dispense);
        document.getElementById("d03").addEventListener("mousedown", dispense);
        document.getElementById("d04").addEventListener("mousedown", dispense);
        function dispense(event) {
            var data = new Uint8Array([1]);
            dispenseId=event.target.parentNode.id;
            data[0]=parseInt(dispenseId.replace("d", ""));
            // data[0]=parseInt(10*Math.random()%4)+1;
            dispansing(data[0]);
            characteristic[0].writeValue(data);
        }
        
        function dispansing(sec) {
            document.querySelector("#connected").style.setProperty("display", "none");
            document.querySelector("#connected").style.setProperty("opacity", "0");
            document.querySelector("#dispensing").style.setProperty("display", "block");
            setTimeout(
                function() {
                    document.querySelector("#dispensing").style.setProperty("display", "none");
                    //document.querySelector("#connected").style.setProperty("display", "block");
                    document.querySelector("#thankyou").style.setProperty("display", "block");
                    setTimeout(function(){
                        document.querySelector("#thankyou").style.setProperty("opacity", "1");
                    }, 20);
                    setTimeout(
                        function() {
                            cntdDevice.gatt.disconnect();
                            connectedHandler("thankyou");
                            document.querySelector("#bticon").innerHTML="bluetooth";
                        }, 2000);
                }, sec*1000+800);
        }
    }
    function service (service) {
        console.log(service);
        Promise.all([
            service.getCharacteristic('19b10001-e8f2-537e-4f6c-984fee0f808e')
        ]).then(handleCandyMagic, error);
    }
    
    function gatt (server) {
        console.log(server);
        server.device.ongattserverdisconnected=function(msg){
            connectedHandler("disconnected");
            console.error("[server disconnected] ", msg);
        };
        server.getPrimaryService('19b10000-e8f2-537e-4f6c-984fee0f808e').then(service, error);
        connectedHandler("connected");
    }
    
    function found (device) {
        cntdDevice=device;
        device.gatt.connect().then(gatt, error);
        console.log("[] ", device.gatt.device);
    }
    
    function error (e) {
        console.log(e);
    }
    
    
    function find () {
        var options = {
            filters: [{
                services: ["19b10000-e8f2-537e-4f6c-984fee0f808e"], // LED Service
                namePrefix: 'CandyMgc'
            }]
        };
        navigator.bluetooth.requestDevice(options).then(found, error);
    }
    
    document.getElementById("find").addEventListener("click", find, false);
    </script>
  </body>
</html>